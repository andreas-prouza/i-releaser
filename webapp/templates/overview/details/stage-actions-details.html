<table class="table table-striped stage_info">
  <tr>
    <th>Description</th><td>{{ stage['description'] }}</td>
    <th>Status</th><td>
      <button type="button" class="btn  
      {% if stage['status'] == 'finished' %}btn-success{% endif %}
      {% if stage['status'] == 'failed' %}btn-danger{% endif %}
      {% if stage['status'] == 'new' %}btn-info{% endif %}
      ">{{ stage['status'] }}</button>
    </td>
  </tr>
  <tr>
    <th>Host</th><td>{{ stage['host'] }}</td>
  </tr>
  <tr>
    <th>Base dir</th><td colspan="3"><code>{{ stage['base_dir'] }}</code></td>
  </tr>
  <tr>
    <th>Build dir</th><td colspan="3"><code>{{ stage['build_dir'] }}</code></td>
  </tr>
  <tr>
    <th>Processing users</th><td>
      <table class="table table-striped table-bordered">
        <thead>
          <th>User</th>
          <th>Timestamp</th>
          <th>Action</th>
        </thead>
        {% for user in stage.processing_users %}
        <tr><td>{{ user['user'] }}</td><td>{{ user['timestamp'] }}</td><td>{{ user['action'] }}</td></tr>
        {% endfor %}
      </table>
    </td>
    <th>Lib mapping</th><td>{{ stage['lib_mapping'] }}</td>
  </tr>
</table>

<br/>
<br/>

<table class="table table-striped table-bordered">
    <thead>
      <th>Sequence</th>
      <th>Step</th>
      <th>Type</th>
      <th>Status</th>
      <th>Check error</th>
      <th>Command</th>
      <th>Logs</th>
    </thead>
    {% for cmd in cmds %}
    <tr>
      <td>{{ cmd['sequence'] }}</td>
      <td>{{ cmd['processing_step'] }}</td>
      <td>{{ cmd['environment'] }}</td>
      <td>
        <button type="button" class="btn  
                {% if cmd['status'] == 'finished' %}btn-success{% endif %}
                {% if cmd['status'] == 'failed' %}btn-danger{% endif %}
                {% if cmd['status'] == 'new' %}btn-info{% endif %}
            ">
          {{ cmd['status'] }}</button>
      </td>
      <td>
        <label class="switch">
          <input type="checkbox" {% if cmd['check_error'] %}checked{% endif %}
            onchange="set_check_error('{{ file_name }}', '{{ stage.name }}', {{ cmd['sequence'] }}, this.checked)">
          <span class="slider round"></span>
        </label>
      </td>
      <td>{% if cmd['cmd'] != '' %}
        {% if cmd['cmd']|length > 30 %}
        <details>
          <summary>{{ cmd['cmd'][:30] }} ...</summary>
          <pre>{{ cmd['cmd']|safe }}</pre>
        </details>
        {% else %}
        {{ cmd['cmd']|safe }}
        {% endif %}
        {% endif %}
      </td>
      <td>
        <table class="table table-striped table-bordered">
          {% for history in cmd['run_history'] %}
          <tr>
            <td>{{ history['create_time'] }}</td>
            <td>
              <button type="button" class="btn  
                            {% if history['status'] == 'finished' %}btn-success{% endif %}
                            {% if history['status'] == 'failed' %}btn-danger{% endif %}
                            {% if history['status'] == 'new' %}btn-info{% endif %}
                        ">
                {{ history['status'] }}
              </button>
            </td>
            <td>{% if history['stdout'] != '' %}<img src="{{ url_for('static', filename='assets/img/log.png') }}"
                onclick="showLog('info', '{{ file_name }}', '{{ stage.name }}', {{ cmd['sequence'] }}, {{loop.index-1}})">&nbsp;{% endif %}
              {% if history['stderr'] != '' %}<img src="{{ url_for('static', filename='assets/img/error-log.png') }}"
                onclick="showLog('error', '{{ file_name }}', '{{ stage.name }}', {{ cmd['sequence'] }}, {{loop.index-1}})">{% endif %}</td>
          </tr>
          {% endfor %}
        </table>
      </td>
    </tr>
    {% endfor %}
  </table>