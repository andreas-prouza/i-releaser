{% extends 'base2.html' %}

{% block title %}
{% endblock %}

{% block content %}
<style>
.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 20px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 13px;
  width: 13px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(18px);
  -ms-transform: translateX(18px);
  transform: translateX(18px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}

.actions td {
    padding-right: 10px;
}

.logs pre {
    overflow-x: auto;
    white-space: pre-wrap;
    white-space: -moz-pre-wrap;
    white-space: -pre-wrap;
    white-space: -o-pre-wrap;
    word-wrap: break-word;
    text-align: left;
}

.run {
    cursor: pointer;
}

</style>

<div class="box box-info">

    <form>
        <input type=button onClick="location.href='/'" value='Back to overview'>
    </form>
    <br/>
    <br/>

    <!-- /.box-header -->
    <div>
        <h2>Projekt: {{ deployment_dict['general']['project'] }} | Version: {{ deployment_dict['general']['deploy_version'] }} </h2>
        <br/>
        <h3>Status: {{ deployment_dict['general']['status'] }} </h3>
    </div>
    <table class="table table-striped table-bordered">
        <tr>
            <th>Created</th><td> {{ deployment_dict['general']['create_time'] }}</td>
        </tr>
        <tr>
            <th>Last update</th><td> {{ deployment_dict['general']['update_time'] }}</td>
        </tr>
        <tr>
            <th>File name</th><td>{{ deployment_dict['general']['file_name'] }}</td>
        </tr>
    </table>


    <hr>


    <br/>
    
    <h3>Completed stages</h3>
    <table class="table table-striped table-bordered">
        <thead>
            <th>Name</th><th>Status</th><th>Last update</th>
        </thead>
        {% for stage in deployment_dict['general']['completed_stages'] %}
        <tr>
            <td>{{ stage['name'] }}</td>
            <td><div {% if stage['status'] == 'finished' %}class="badge badge-success"{% endif %}
                    {% if stage['status'] == 'failed' %}class="badge badge-danger"{% endif %}
                    {% if stage['status'] == 'new' %}class="badge badge-info"{% endif %}
                    >
                    {{ stage['status'] }}
                </div>
            </td>
            <td>{{ stage['update_time'] }}</td>
        </tr>
        {% endfor %}
    </table>

    
    <hr>
    
    <br/>

    <h3>Current stages</h3>
    <table class="table table-striped table-bordered">
        <thead>
            <th>Name</th><th>Status</th><th>Last update</th>
        </thead>
        {% for stage in deployment_dict['general']['current_stages'] %}
        <tr>
            <td>{{ stage['name'] }}</td>
            <td>
                {% if stage['status'] == 'new' %}<img class="run" src="{{ url_for('static', filename='assets/img/run-green.png') }}" onclick="runStage('{{ deployment_dict['general']['file_name'] }}', '{{ stage['name'] }}')">{% endif %}
                {% if stage['status'] == 'failed' %}<img class="run" src="{{ url_for('static', filename='assets/img/run-red.png') }}" onclick="runStage('{{ deployment_dict['general']['file_name'] }}', '{{ stage['name'] }}')">{% endif %}
                <div {% if stage['status'] == 'finished' %}class="badge badge-success"{% endif %}
                                {% if stage['status'] == 'failed' %}class="badge badge-danger"{% endif %}
                                {% if stage['status'] == 'new' %}class="badge badge-info"{% endif %}
                                >
                            {{ stage['status'] }}
                </div>
            </td>
            <td>{{ stage['update_time'] }}</td>
        </tr>
        {% endfor %}
    </table>


    <hr>
    
    <br/>

    <h3>Deployment actions</h3>
    <table>
        {% for stage, cmds in deployment_dict['deploy_cmds'].items() %}
        <tr>
            <td><details>
                <summary>{{ stage }}</summary>
                <table class="table table-striped table-bordered">
                    <thead>
                        <th>Sequence</th>
                        <th>Step</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Check error</th>
                        <th>Command</th>
                        <th>Logs</th>
                    </thead>
                    {% for cmd in cmds %}
                    <tr>
                        <td>{{ cmd['sequence'] }}</td>
                        <td>{{ cmd['processing_step'] }}</td>
                        <td>{{ cmd['environment'] }}</td>
                        <td>
                            <div {% if cmd['status'] == 'finished' %}class="badge badge-success"{% endif %}
                                {% if cmd['status'] == 'failed' %}class="badge badge-danger"{% endif %}
                                {% if cmd['status'] == 'new' %}class="badge badge-info"{% endif %}
                                >
                            {{ cmd['status'] }}</div>
                        </td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" {% if cmd['check_error'] %}checked{% endif %} onchange="set_check_error('{{ deployment_dict['general']['file_name'] }}', '{{ stage }}', {{ cmd['sequence'] }}, this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </td>
                        <td>{% if cmd['cmd'] != '' %}
                                {% if cmd['cmd']|length > 30 %}
                                    <details><summary>{{ cmd['cmd'][:30] }} ...</summary><pre>{{ cmd['cmd'] }}</pre></details>
                                {% else %}
                                    {{ cmd['cmd'] }}
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            <table class="table table-striped table-bordered">
                            {% for history in cmd['run_history'] %}
                                <tr>
                                    <td>{{ history['create_time'] }}</td>
                                    <td>
                                        <div {% if history['status'] == 'finished' %}class="badge badge-success"{% endif %}
                                            {% if history['status'] == 'failed' %}class="badge badge-danger"{% endif %}
                                            {% if history['status'] == 'new' %}class="badge badge-info"{% endif %}
                                            >
                                            {{ history['status'] }}
                                        </div>
                                    </td>
                                    <td>{% if history['stdout'] != '' %}<img src="{{ url_for('static', filename='assets/img/log.png') }}" onclick="showLog('info', '{{ history['stdout']|replace("'", "\"")|replace("\r\n", "<br/>")|replace("\n", "<br/>")|e }}')">&nbsp;{% endif %}
                                        {% if history['stderr'] != '' %}<img src="{{ url_for('static', filename='assets/img/error-log.png') }}" onclick="showLog('error', '{{ history['stderr']|replace("'", "\"")|replace("\r\n", "<br/>")|replace("\n", "<br/>")|e }}')">{% endif %}</td>
                                </tr>
                            {% endfor %}
                            </table>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
              </details>
            </td>
        </tr>
        {% endfor %}
    </table>


    <hr>

    
    <br/>

    <h3>Objects to deploy</h3>
    <table class="table table-striped table-bordered">
        <thead>
            <th>Production Lib</th><th>Name</th><th>Type</th><th>Attribute</th><th>Status</th>
        </thead>
        {% for object in deployment_dict['objects'] %}
        <tr>
            <td>{{ object['obj_prod_lib'] }}</td>
            <td>{{ object['obj_name'] }}</td>
            <td>{{ object['obj_type'] }}</td>
            <td>{{ object['obj_attribute'] }}</td>
            <td>{{ object['obj_status'] }}</td>
        </tr>
        {% endfor %}
    </table>

    <hr>
    
    <br/>

    <h3>Raw JSON file</h3>

    <pre class="prettyprint lang-js">
        {{ deployment_json }}
    </pre>
</div>


<script src="{{ url_for('static', filename='assets/js/sweetalert2.all.min.js') }}"></script>

<script type="text/javascript">

    (function(d) {

stylizePreElements = function() {
  var preElements = document.getElementsByTagName("pre");
  for (i = 0; i < preElements.length; ++i) {
    var preElement = preElements[i];
    preElement.className += "prettyprint";
  }
};

injectPrettifyScript = function() {
  // https://github.com/googlearchive/code-prettify
  var scriptElement = document.createElement('script');
  scriptElement.setAttribute("src", "https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js");
  document.head.appendChild(scriptElement);
};

stylizePreElements();
injectPrettifyScript();

})(document)


function showLog(type, text) {
    Swal.fire({
  icon: type,
  title: 'Log',
  html: '<pre class="logs">'+text+'</pre>',
  width: 'auto',
  customClass: {
    popup: 'logs'
  }
});
}


async function postData(url = "", data = {}) {
  // Default options are marked with *
  const response = await fetch(url, {
    method: "POST", // *GET, POST, PUT, DELETE, etc.
    mode: "cors", // no-cors, *cors, same-origin
    cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
    credentials: "same-origin", // include, *same-origin, omit
    headers: {
      "Content-Type": "application/json",
      // 'Content-Type': 'application/x-www-form-urlencoded',
    },
    redirect: "follow", // manual, *follow, error
    referrerPolicy: "no-referrer", // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
    body: JSON.stringify(data), // body data type must match "Content-Type" header
  });
  return response.json(); // parses JSON response into native JavaScript objects
}



function runStage(filename, stage) {
    postData("/run_stage", { stage: stage, filename: filename }).then((data) => {
        console.log(data); // JSON data parsed by `data.json()` call
        location.reload();
    });
}

function set_check_error(filename, stage, sequence, checked) {
    postData("/set_check_error", { stage: stage, filename: filename, sequence: sequence, checked: checked }).then((data) => {
        console.log(data); // JSON data parsed by `data.json()` call
    });
}

</script>

{% endblock %}
